---
layout: post
title:  "测试环境软件安装笔记"
date:   2020-06-02 11:12:31
categories:  
tags: 
excerpt: 
mathjax: true
---



  
一、安装mysql 
1、创建工作目录 
              # mkdir -p /data/mysql/build 
              # cd /data/mysql/build 
       2、下载程序（mysql 5.7和boost 的源码包） 
              # wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.23.tar.gz 
              # 
wget http://sourceforge.net/projects/boost/files/boost/1.59.0/boost_1_59_0.tar.gz 
       3、安装编译依赖的环境 
              # yum -y install gcc gcc-c++ ncurses ncurses-devel cmake bison 
       4、创建系统用户和组 
              # groupadd -r mysql 
              # useradd -r -g mysql -s /sbin/nologin -M mysql 
       5、编译安装 
              # tar xvf boost_1_59_0.tar.gz 
              # tar xvf mysql-5.7.23.tar.gz 


              # cmake . -DCMAKE_INSTALL_PREFIX=/usr/local/mysql \ 
          -DMYSQL_DATADIR=/data/mysql \ 
          -DDOWNLOAD_BOOST=1 \ 
          -DWITH_BOOST=../boost_1_59_0 \ 
          -DSYSCONFDIR=/etc \ 
          -DWITH_INNOBASE_STORAGE_ENGINE=1 \ 
          -DWITH_PARTITION_STORAGE_ENGINE=1 \ 
          -DWITH_FEDERATED_STORAGE_ENGINE=1 \ 
          -DWITH_BLACKHOLE_STORAGE_ENGINE=1 \ 
          -DWITH_MYISAM_STORAGE_ENGINE=1 \ 
          -DENABLED_LOCAL_INFILE=1 \ 
          -DENABLE_DTRACE=0 \ 
          -DDEFAULT_CHARSET=utf8mb4 \ 
          -DDEFAULT_COLLATION=utf8mb4_unicode_ci \ 
          -DWITH_EMBEDDED_SERVER=1 

cd mysql-5.7.23
          # make -j `grep processor /proc/cpuinfo | wc -l`  
          # make install 
        6、配置Mysql数据库 
             # vim /etc/my.cnf 
                     [client] 
                     port = 3306 
                     socket = /tmp/mysql.sock 
                     default-character-set = utf8mb4 
  
                     [mysqld] 
                     port = 3306 
                     socket = /tmp/mysql.sock 
  
                     basedir = /usr/local/mysql 
                     datadir = /data/mysql 
                     pid-file = /data/mysql/mysql.pid 
                     user = mysql 
                     bind-address = 0.0.0.0 
                     server-id = 1 
  
                     init-connect = 'SET NAMES utf8mb4' 
                     character-set-server = utf8mb4 
  
                     #skip-name-resolve 
                     #skip-networking 
                     back_log = 300 
  
                     max_connections = 1000 
                     max_connect_errors = 6000 
                     open_files_limit = 65535 
                     table_open_cache = 128 
                     max_allowed_packet = 4M 
                     binlog_cache_size = 8M 
                     max_binlog_cache_size=512M 
                     max_binlog_size=512M 
                     max_heap_table_size = 8M 
                     tmp_table_size = 16M 
  
                     read_buffer_size = 2M 
                     read_rnd_buffer_size = 8M 
                     sort_buffer_size = 8M 
                     join_buffer_size = 8M 
                     key_buffer_size = 4M 
  
                     thread_cache_size = 8 
  
                     query_cache_type = 1 
                     query_cache_size = 8M 
                     query_cache_limit = 2M 
  
                     ft_min_word_len = 4 
                     log_bin = /data/mysql/logbin.log 
                     log_bin_index=/data/mysql/logindex 
                     binlog_format = ROW 
                     expire_logs_days = 30 
  
                     log_error = /data/mysql/mysql-error.log 
                     slow_query_log = 1 
                     long_query_time = 1 
                     slow_query_log_file = /data/mysql/mysql-slow.log 
  
                     performance_schema = 0 
                     explicit_defaults_for_timestamp 
  
                     #lower_case_table_names = 1 
                     skip-external-locking 
  
                     default_storage_engine = InnoDB 
                     #default-storage-engine = MyISAM 
                     innodb_file_per_table = 1 
                     innodb_open_files = 500 
                     innodb_buffer_pool_size = 64M 
                     innodb_write_io_threads = 4 
                     innodb_read_io_threads = 4 
                     innodb_thread_concurrency = 0 
                     innodb_purge_threads = 1 
                     innodb_flush_log_at_trx_commit = 2 
                     innodb_log_buffer_size = 2M 
                     innodb_log_file_size = 32M 
                     innodb_log_files_in_group = 3 
                     innodb_max_dirty_pages_pct = 90 
                     innodb_lock_wait_timeout = 120 
  
                     bulk_insert_buffer_size = 8M 
                     myisam_sort_buffer_size = 8M 
                     myisam_max_sort_file_size = 10G 
                     myisam_repair_threads = 1 
  
                     interactive_timeout = 28800 
                     wait_timeout = 28800 
  
                     [mysqldump] 
                     quick 
                     max_allowed_packet = 16M 
  
                     [myisamchk] 
                     key_buffer_size = 8M 
                     sort_buffer_size = 8M 
                     read_buffer = 4M 
                     write_buffer = 4M 
7、初始化数据库 
              # cd /data 
              # rm -rf /data/mysql/build 
              # /usr/local/mysql/bin/mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql 
       8、设置启动脚本并设置开机启动 
              # cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld 
              # chmod +x /etc/init.d/mysqld 
              # systemctl enable mysqld 
              # systemctl start mysqld 
       9、设置环境变量 
              # vim /etc/profile/mysql.sh 
                     PATH=/usr/local/mysql/bin/:$PATH 
              # source /etc/profile/mysql.sh 
       10、授权      #测试环境需要将数据库还原 
              # mysql -uroot -p 
              mysql> GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '123456' WITH GRANT OPTION; 
              mysql> FLUSH PRIVILEGES; 


二、安装PHP #现在是按照正式环境下安装的，storage用的是7.2.9，是以sock方式连接的，还有一个PHP是7.2.12，以端口方式连接的 
1、下载源码包程序 
       # mkdir /tmp/php_build 
       # cd /tmp/php_build 
       # wget http://cn2.php.net/distributions/php-7.2.9.tar.xz 
  
2、安装依赖 
       # yum install -y gcc-c++ libxml2-devel libxml2-devel libcurl-devel libcurl-devel openssl-devel libjpeg libjpeg-devel libpng libpng-devel freetype freetype-devel 
  
3、创建用户和组 
       # groupadd -r www 
       # useradd -s /usr/sbin/nologin -r -M -N www 
  
4、编译安装 
       # tar Jxvf php-7.2.9.tar.xz -C /usr/local/ 
       # cd /usr/local/php-7.2.9 
       # ./configure --prefix=/usr/local/php-7.2.9 --with-config-file-path=/usr/local/php-7.2.9/etc --bindir=/usr/local/php-7.2.9/bin --sbindir=/usr/local/php-7.2.9/sbin --enable-fpm --with-fpm-user=www --with-fpm-group=www --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-iconv-dir --with-freetype-dir=/usr/local/freetype --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --enable-mbregex --enable-mbstring --with-gd --with-openssl --enable-pcntl --enable-sockets --with-mhash --with-xmlrpc --enable-zip --enable-soap --with-gettext --disable-fileinfo --enable-opcache 

#php-7.2.12
#./configure --prefix=/usr/local/php-7.2.12 --with-config-file-path=/usr/local/php-7.2.12/etc --bindir=/usr/local/php-7.2.12/bin --sbindir=/usr/local/php-7.2.12/sbin --enable-fpm --with-fpm-user=www --with-fpm-group=www --enable-mysqlnd --with-mysqli=mysqlnd --with-pdo-mysql=mysqlnd --with-iconv-dir --with-freetype-dir=/usr/local/freetype --with-jpeg-dir --with-png-dir --with-zlib --with-libxml-dir=/usr --enable-xml --disable-rpath --enable-bcmath --enable-shmop --enable-sysvsem --enable-inline-optimization --with-curl --enable-mbregex --enable-mbstring --with-gd --with-openssl --enable-pcntl --enable-sockets --with-mhash --with-xmlrpc --enable-zip --enable-soap --with-gettext --disable-fileinfo --enable-opcache

  
   # make -j `grep processor /proc/cpuinfo | wc -l` 
   # make install 


php装完后，需要手动修改php配置文件

三、安装redis            ##php需要连接redis，没有密码不行，所以一定要给redis设置密码 
1、下载源码包程序 
       # mkdir /tmp/redis_build 
       # cd /tmp/redis_build 
       # wget http://download.redis.io/releases/redis-4.0.11.tar.gz 
       # wget https://github.com/jemalloc/jemalloc/releases/download/5.1.0/jemalloc-5.1.0.tar.bz2 
  
2、安装 
       # yum install gcc-c++ bzip2 
       # tar jxvf jemalloc-5.1.0.tar.bz2 
       # cd jemalloc-5.1.0 
    # ./configure --prefix=/usr/local/jemalloc 
    # make -j `grep processor /proc/cpuinfo | wc -l` 
    # make install 
    # cd ../ 
    # tar zxvf redis-4.0.11.tar.gz 
    # cd redis-4.0.11 
    # make -j `grep processor /proc/cpuinfo | wc -l` MALLOC=/usr/local/jemalloc/lib 
    # make install PREFIX=/usr/local/redis 
  
3、设置环境变量 
       # vim /etc/profile/redis.sh 
              PATH=/usr/local/redis/bin:$PATH 
       # source /etc/profile/redis.sh 
  
4、解决启动报警 
       # echo "vm.overcommit_memory = 1" >> /etc/sysctl.conf 
       # echo " net.core.somaxconn= 4096" >> /etc/sysctl.conf 
     # echo never > /sys/kernel/mm/transparent_hugepage/enabled 
     # sysctl -p 
  
5、初始化 redis 配置, 创建 redis 启动脚本 

需要手动创建脚本，start.sh  stop.sh

需要复制redis.conf 
并修改start.sh  stop.sh这两个脚本内容
  
   ```bash 
   # 执行该工具, 会自动创建 redis 启动脚本 
   # 如需要启动多个 redis 实例, 请再次执行此脚本 
   ./utils/install_server.sh 
   

redis

   # 开机启动 redis 
   systemctl enable redis_6379 
   systemctl start redis_6379 
   
   # 如果 redis 有设置密码，请在 /etc/init.d/redis 中加入以下命令 
   PASSWORD=$(cat $CONF|grep '^\s*requirepass'|awk '{print $2}'|sed 's/"//g') 
   
   ## stop 关闭脚本的地方改为 
   $CLIEXEC -p $REDISPORT -a $PASSWORD shutdown 




四、安装mongodb 
1、下载mongodb安装包 
cd /opt 
wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-4.0.10.tgz 
2、解压安装包 
tar -xvf mongodb-linux-x86_64-4.0.10.tgz 
3、在/opt/mongodb-4.0.10目录下创建mongo.conf 
mv mongodb-linux-x86_64-4.0.10 mongodb-4.0.10 
cd mongodb-4.0.10 
vim mongo.conf 
systemLog: 
   destination: file 
   path: "/opt/mongodb-4.0.10/logs/mongodb.log" 
   logAppend: true 
storage: 
   dbPath: "/data/mongodb" 
   journal: 
      enabled: true 
   mmapv1: 
     smallFiles: true 
   wiredTiger: 
      engineConfig: 
        configString: cache_size=345M 
processManagement: 
      fork: true 
net: 
   #bindIp: 127.0.0.1 
   port: 27017 
setParameter: 
   enableLocalhostAuthBypass: false 
  
4、创建mongodb数据目录，和日志目录 
mkdir  -p  /data/mongodb 
mkdir  /opt/mongodb-4.0.10/logs 
5、在/opt/mongodb-4.0.10下创建启动脚本和停止脚本 
vim start.sh 
/opt/mongodb-4.0.10/bin/mongod --config=/opt/mongodb-4.0.10/mongo.conf 
vim stop.sh 
ps -ef|grep mongo.conf|grep -v grep|awk '{printf $2}'|xargs kill -9 
  
五、安装rocketmq 
1、下载rocketmq 
cd /opt 
wget http://mirror.bit.edu.cn/apache/rocketmq/4.3.2/rocketmq-all-4.3.2-bin-release.zip 
unzip rocketmq-all-4.3.2-bin-release.zip 
cd /opt/rocketmq-all-4.3.2-bin-release 
2、修改rocketmq配置 
3、调整rocketMq 的内存值，这一步很重要，根据服务器内存大小调整参数，要不然内存不够会启动不了或者死掉 
vim  bin/runbroker.sh 
JAVA_OPT="${JAVA_OPT} -server -Xms512m -Xmx512m -Xmn512m" 
JAVA_OPT="${JAVA_OPT} -XX:MaxDirectMemorySize=1g" 
vim bin/runserver.sh 
JAVA_OPT="${JAVA_OPT} -server -Xms1g -Xmx1g -Xmn1g -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=320m" 
4、创建启动文件 
vim startSrv 
nohup sh ./bin/mqnamesrv -n 47.106.241.20:9876  >  ~/logs/rocketmqlogs/namesrv.log  & 
tail -f ~/logs/rocketmqlogs/namesrv.log 
vim startBroker 
nohup sh bin/mqbroker -n  47.106.241.20:9876  >  ~/logs/rocketmqlogs/broker.log   & 
tail  -f  ~/logs/rocketmqlogs/broker.log 
vim stopSrv 
sh bin/mqshutdown namesrv 
vim stopBroker 
sh bin/mqshutdown broker 

5、注册话题 
sh bin/mqadmin updateTopic -n 172.18.18.232:9876  -c DefaultCluster  -t SELF_TEST_TOPIC 
sh bin/mqadmin updateTopic -n 172.18.18.232:9876  -c DefaultCluster  -t 172-18-18-231_deliver 
sh bin/mqadmin updateTopic -n 172.18.18.232:9876  -c DefaultCluster  -t 172-18-18-231_handler 
  
172.18.18.231


6、安装web管理界面 ##视具体情况而定，需要就安装 
1)      下载安装包 
wget https://github.com/apache/rocketmq-externals/archive/master.zip 
2)      解压并配置修改配置文件 
unzip master.zip    ##解压后文件名为rocketmq-externals-master 
cd rocketmq-externals-master 
vim rocketmq-console/src/main/resources/application.properties 
server.port=8080          #设置访问端口 
rocketmq.config.namesrvAddr=IP:9876   #设置rocket的IP和端口 
rocketmq.config.dataPath=/tmp/rocketmq-console/data #数据保存的路径 
3)      编译rocketmq-console 
cd rocketmq-externals-master/rocketmq-console #在这个目录下进行编译 
mvn clean package -Dmaven.test.skip=true #编译完成后，会在target目录下生成rocketmq-console-ng-1.0.1.jar 
4)      运行jar包 
java -jar rocketmq-console-ng-1.0.1.jar 
5)      浏览器访问 
http://ip:8080/ 
  
  
六、安装lexin_java 
将测试环境/opt/lexin-java目录下的文件拷贝过来 

七、安装nginx+fastdfs 
由于测试环境中有fastdfs也需要使用nginx，需要添加fastdfs-nginx-module模块编译，安装编译参考“搭建单机fastdfs” ，其他nginx功能配置文件参考测试服务器 
  
八、配置PHP目录文件和nginx家目录，nginx需要读取这三个目录的文件，所以拥有者要为www 
wwwroot.tar.gz   #nginx家目录 
www.tar.gz           #storage的家目录（php-7.2.9） 
phproot.tar.gz  #manage的家目录（php-7.2.12） 
在两个PHP目录中，找到配置.env   并修改 
find /www -name .env 
vim /www/filesystem/releases/16/.env 
只改ip，改成本服务器的ip地址
修改之后需要同步所以的.env配置 
/usr/local/php-7.2.12/bin/php artisan config:clear 
  

最后需要替换phproot目录下面的两个文件：
default.php		/phproot/api/current/routes/api/v1			6.13已更新	/wwwroot/api/current/routes/api/v1		5.27已更新
FriendsController.php	/phproot/api/current/app/Http/Controllers/Api/V1/		6.13已更新	/wwwroot/api/current/app/Http/Controllers/Api/V1/	5.27已更新


----------------




一、安装lexin_java 
将测试环境/opt/lexin-java目录下的文件拷贝过来,主要提供乐信相关接口，配置文件是application.yml，需要配置端口、mysql数据库信息、redis信息、mongodb、乐信认证登录退出地址等信息 
执行命令：nohup java -jar /opt/lexin-java/httpLogicServer-1.0-SNAPSHOT.jar --spring.config.location=/opt/lexin-java/application.yml > /opt/lexin-java/log.log & 
  

二、安装lexin_push 
代替原乐信gobelieve_push,监听端口在push-app.py文件中配置，默认是7777，需要安装python3，安装requirements.txt里面的依赖。 
执行命令：python3 push-app.py 
  

三、安装manage 
新的乐信管理后台,监听端口在app.py文件中配置,默认是8880，需要安装python3，安装requirements.txt里面的依赖。 
执行命令：python3 app.py 
config.py
	    api_domain = "127.0.0.1:9908/web/"
  

四、安装phpqueue 
phpqueue是处理PHP消息队列的程序，配置文件redis_del.py，需要配置redis的信息，需要安装python3，安装requirements.txt里面的依赖。 
执行命令：python3 redis_del.py 








  




